# CLAUDE.md

This file provides guidance for AI assistants working with the lookpath codebase.

## Project Overview

**lookpath** is a minimal TypeScript/Node.js library for finding executables in the system PATH. It is the npm equivalent of Go's `exec.LookPath()` — a lightweight, zero-dependency way to check if a command exists and retrieve its absolute path without spawning child processes.

- **Package:** `lookpath` on npm (v1.2.2)
- **License:** MIT
- **Author:** Hiromu OCHIAI (@otiai10)

## Repository Structure

```
src/index.ts          # Entire library implementation (~89 lines)
bin/lookpath.js       # CLI entry point (compiled JS, shebang)
tests/
  lookpath.spec.ts    # Jest test suite (8 test cases)
  data/               # Test fixtures (executable/non-executable files)
    bin/              # hello_world (executable), goodbye_world (non-executable)
    bin_1/            # hello_mike (executable)
    bin_2/            # hello_john (executable)
lib/                  # Compiled output (gitignored, generated by `npm run build`)
```

## Public API

Two exports from `src/index.ts`:

- `lookpath(command: string, opt?: LookPathOption): Promise<string | undefined>` — Main function. Returns absolute path to the executable or `undefined`.
- `LookPathOption` — Interface with optional fields: `include` (extra search dirs), `exclude` (dirs to skip), `env` (custom environment).

## Commands

| Command | Purpose |
|---------|---------|
| `npm ci` | Clean install of dependencies |
| `npm run build` | Compile TypeScript (`rm -rf ./lib && tsc`) |
| `npm run lint` | ESLint on `src/index.ts` and `tests/lookpath.spec.ts` |
| `npm test` | Run Jest tests |
| `npm test -- --coverage` | Run tests with coverage report |
| `npm run validate` | Build + smoke-test CLI (`node ./bin/lookpath.js npm`) |
| `npm run release` | Build, validate, and publish to npm |

Run the full CI check locally: `npm ci && npm run build && npm run validate && npm run lint && npm test -- --coverage`

## Tech Stack and Configuration

- **Language:** TypeScript 4.x with strict mode enabled
- **Target:** ES5, CommonJS modules
- **Test framework:** Jest 27 with ts-jest
- **Linter:** ESLint with `@typescript-eslint/recommended`
- **Runtime dependencies:** None (zero dependencies — uses only Node.js built-ins `fs` and `path`)
- **Node.js:** Tested on 16.x, 18.x, 20.x
- **Platforms:** Linux, macOS, Windows (CI matrix covers all three)

## Code Conventions

- **Naming:** camelCase for functions/variables, PascalCase for interfaces
- **Documentation:** JSDoc comments on all functions (including `@private` for internal helpers)
- **Error handling:** Return `undefined` instead of throwing — the function is designed to gracefully report "not found"
- **Async pattern:** Promise-based with `Promise.all()` for parallel filesystem checks
- **Platform handling:** Runtime detection via `process.platform` for Windows-specific behavior (PATHEXT, Path vs PATH env var)
- **ESLint rule override:** `@typescript-eslint/explicit-function-return-type` is disabled — return types are inferred

## Architecture Notes

The library is intentionally minimal (~89 lines). The flow is:

1. Check if the input is a file path (contains path separator) — if so, check executability directly
2. Otherwise, build a list of directories from PATH (plus `include`, minus `exclude`)
3. Check each directory in parallel for the command with executable permissions
4. On Windows, also checks each PATHEXT extension

Internal helpers: `isFilepath()`, `access()`, `isExecutable()`, `getDirsToWalkThrough()`

## CI/CD

- **GitHub Actions:** `.github/workflows/node.js.yml` — runs on push/PR to main/develop, 3x3 matrix (3 OSes x 3 Node versions)
- **CodeQL:** `.github/workflows/codeql-analysis.yml` — security analysis on push/PR to main
- **Dependabot:** `.github/dependabot.yml` — monthly npm dependency updates
- **Coverage:** Uploaded to Codecov after test runs

## Testing

Tests are in `tests/lookpath.spec.ts`. They cover:

1. Non-existing commands return `undefined`
2. Existing commands (e.g., `node`) are found
3. `include` option adds search paths
4. `exclude` option filters out paths
5. Relative and absolute file paths work
6. Non-executable files return `undefined` (Unix only)
7. Case-insensitive matching on Windows/macOS
8. Custom `env` option replaces `process.env`

Test fixtures in `tests/data/` use real files with specific permission bits. The `beforeAll` hook explicitly sets `goodbye_world` to non-executable (0o644).
